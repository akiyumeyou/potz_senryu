function p(t,a,i){const c=t.height;switch(a){case"top":return 20+parseInt(i);case"center":return c/2+parseInt(i)/2;case"bottom":return c-20;default:return 20+parseInt(i)}}document.addEventListener("DOMContentLoaded",function(){const t=document.getElementById("preview-canvas"),a=t.getContext("2d"),i=document.getElementById("image"),c=document.getElementById("drop-area"),u=document.getElementById("file-name"),f=document.getElementById("generated-image"),h=document.getElementById("file-name-preview");let s=null,g="";i.addEventListener("change",function(o){const n=o.target.files[0];if(n&&n.type.startsWith("image/")){g=n.name.split(".").slice(0,-1).join(".");const r=new FileReader;r.onload=function(l){s=new Image,s.onload=function(){t.width=320,t.height=440,a.drawImage(s,0,0,t.width,t.height)},s.src=l.target.result},r.readAsDataURL(n),u.textContent="選択されたファイル: "+n.name}else u.textContent="選択されたファイルは画像ではありません。"}),["dragover","dragenter","dragleave","dragend","drop"].forEach(o=>{c.addEventListener(o,function(n){if(n.preventDefault(),["dragover","dragenter"].includes(o)?c.classList.add("active"):c.classList.remove("active"),o==="drop"&&n.dataTransfer.files.length){i.files=n.dataTransfer.files;const r=new Event("change");i.dispatchEvent(r)}},!1)}),c.addEventListener("click",function(){i.click()}),document.getElementById("apply-text").addEventListener("click",function(){if(!s){alert("先に画像を選択してください。");return}const o=document.getElementById("text-overlay").value,n=document.getElementById("text-color").value,r=document.getElementById("text-position").value,l=document.getElementById("text-size").value;a.clearRect(0,0,t.width,t.height),a.drawImage(s,0,0,t.width,t.height),a.font=`${l}px Arial`,a.fillStyle=n,a.textAlign="center";const m=p(t,r,l);a.fillText(o,t.width/2,m);const d=t.toDataURL("image/png");f.src=d,f.style.display="block",h.textContent=`生成されたファイル名: ${g}.png`}),document.getElementById("stamp-form").addEventListener("submit",function(o){if(o.preventDefault(),!s){alert("先に画像を選択してください。");return}const n=t.toDataURL("image/png"),r=atob(n.split(",")[1]),l=[];for(let e=0;e<r.length;e++)l.push(r.charCodeAt(e));const m=new Blob([new Uint8Array(l)],{type:"image/png"}),d=new FormData(this);d.append("image",m,`${g}.png`);for(let e of d.entries())console.log(e[0]+": "+e[1]);fetch(this.action,{method:"POST",body:d,headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")}}).then(e=>{if(!e.ok)throw new Error("Network response was not ok "+e.statusText);return e.json()}).then(e=>{e.success?(alert("スタンプが作成されました。"),window.location.reload()):alert("スタンプの作成に失敗しました。 "+e.message)}).catch(e=>{console.error("エラーが発生しました:",e),alert("スタンプの作成に失敗しました。 "+e.message)})})});
