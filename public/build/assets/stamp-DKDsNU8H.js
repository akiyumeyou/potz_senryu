document.addEventListener("DOMContentLoaded",function(){const r=document.getElementById("preview-canvas"),g=r.getContext("2d"),i=document.getElementById("image"),s=document.getElementById("drop-area"),d=document.getElementById("file-name");document.getElementById("generated-image"),document.getElementById("file-name-preview");let o=null,l="";i.addEventListener("change",function(n){const t=n.target.files[0];if(t&&t.type.startsWith("image/")){l=t.name.split(".").slice(0,-1).join(".");const a=new FileReader;a.onload=function(c){o=new Image,o.onload=function(){r.width=320,r.height=440,g.drawImage(o,0,0,r.width,r.height)},o.src=c.target.result},a.readAsDataURL(t),d.textContent="選択されたファイル: "+t.name}else d.textContent="選択されたファイルは画像ではありません。"}),["dragover","dragenter","dragleave","dragend","drop"].forEach(n=>{s.addEventListener(n,function(t){if(t.preventDefault(),["dragover","dragenter"].includes(n)?s.classList.add("active"):s.classList.remove("active"),n==="drop"&&t.dataTransfer.files.length){i.files=t.dataTransfer.files;const a=new Event("change");i.dispatchEvent(a)}},!1)}),s.addEventListener("click",function(){i.click()}),document.getElementById("stamp-form").addEventListener("submit",function(n){if(n.preventDefault(),!o){alert("先に画像を選択してください。");return}const t=r.toDataURL("image/png"),a=atob(t.split(",")[1]),c=[];for(let e=0;e<a.length;e++)c.push(a.charCodeAt(e));const f=new Blob([new Uint8Array(c)],{type:"image/png"}),m=new FormData(this);m.append("image",f,`${l}.png`),fetch(this.action,{method:"POST",body:m,headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")}}).then(e=>e.json().catch(u=>{throw new Error("Failed to parse JSON: "+u.message)})).then(e=>{e.success?window.location.href=e.redirect_url:alert("スタンプの作成に失敗しました。 "+e.message)}).catch(e=>{console.error("エラーが発生しました:",e),alert("スタンプの作成に失敗しました。 "+e.message)})})});
