document.addEventListener("DOMContentLoaded",function(){const s=document.getElementById("start-record-btn"),p=document.getElementById("send-btn"),i=document.getElementById("content"),o=document.getElementById("transcription-feedback"),f=document.getElementById("transcribe-route").value,h=document.getElementById("chat-route").value,y=document.getElementById("user-name").value;document.getElementById("conversation");const g=document.getElementById("conversation-history");let n,c=[],m=[];E(),s.addEventListener("click",async()=>{!n||n.state==="inactive"?v():w()}),p.addEventListener("click",async()=>{const e=i.value;if(e.trim().length===0){o.textContent="Please enter or transcribe some text first.";return}try{const t=await fetch(h,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify({text:e})});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const r=await t.json();d({sender:y,text:e,timestamp:new Date().toLocaleTimeString()}),d({sender:"AI",text:r.response,timestamp:new Date().toLocaleTimeString()}),i.value=""}catch(t){o.textContent="Request failed: "+t.message,console.error("Request failed:",t)}});async function v(){const e=await navigator.mediaDevices.getUserMedia({audio:!0});n=new MediaRecorder(e),n.ondataavailable=t=>{c.push(t.data)},n.onstop=async()=>{const t=new Blob(c,{type:"audio/mp3"});c=[];const r=new FormData;r.append("audio",t,"audio.mp3");try{const l=await(await fetch(f,{method:"POST",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:r})).text();if(l.startsWith("<!DOCTYPE html>"))throw new Error("Received HTML response instead of JSON");const a=JSON.parse(l);a.transcription?(i.value=a.transcription,o.textContent="Transcription successful"):o.textContent=a.error?"Transcription failed: "+a.error:"Transcription failed"}catch(u){o.textContent="Transcription request failed: "+u.message,console.error("Transcription request failed:",u)}},n.start(),s.textContent="â¹ Stop Recording",o.textContent="Recording..."}function w(){n.stop(),s.textContent="ðŸŽ¤ Start Recording"}function d(e){m.push(e),g.innerHTML=m.map(t=>`<div><strong>${t.sender}</strong> (${t.timestamp}): ${t.text}</div>`).join("")}async function E(){try{const e=await fetch("/conversation-history");if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const t=await e.json();if(t.error)throw new Error(t.error);t.forEach(r=>{d(r)})}catch(e){console.error("Failed to load conversation history:",e)}}});
