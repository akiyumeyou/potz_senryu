function p(e,a,r){const c=e.height;switch(a){case"top":return 20+parseInt(r);case"center":return c/2+parseInt(r)/2;case"bottom":return c-20;default:return 20+parseInt(r)}}document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("preview-canvas"),a=e.getContext("2d"),r=document.getElementById("image"),c=document.getElementById("drop-area"),u=document.getElementById("file-name"),f=document.getElementById("generated-image"),h=document.getElementById("file-name-preview");let s=null,g="";r.addEventListener("change",function(o){const t=o.target.files[0];if(t&&t.type.startsWith("image/")){g=t.name.split(".").slice(0,-1).join(".");const i=new FileReader;i.onload=function(d){s=new Image,s.onload=function(){e.width=320,e.height=440,a.drawImage(s,0,0,e.width,e.height)},s.src=d.target.result},i.readAsDataURL(t),u.textContent="選択されたファイル: "+t.name}else u.textContent="選択されたファイルは画像ではありません。"}),["dragover","dragenter","dragleave","dragend","drop"].forEach(o=>{c.addEventListener(o,function(t){if(t.preventDefault(),["dragover","dragenter"].includes(o)?c.classList.add("active"):c.classList.remove("active"),o==="drop"&&t.dataTransfer.files.length){r.files=t.dataTransfer.files;const i=new Event("change");r.dispatchEvent(i)}},!1)}),c.addEventListener("click",function(){r.click()}),document.getElementById("apply-text").addEventListener("click",function(){if(!s){alert("先に画像を選択してください。");return}const o=document.getElementById("text-overlay").value,t=document.getElementById("text-color").value,i=document.getElementById("text-position").value,d=document.getElementById("text-size").value;a.clearRect(0,0,e.width,e.height),a.drawImage(s,0,0,e.width,e.height),a.font=`${d}px Arial`,a.fillStyle=t,a.textAlign="center";const m=p(e,i,d);a.fillText(o,e.width/2,m);const l=e.toDataURL("image/png");f.src=l,f.style.display="block",h.textContent=`生成されたファイル名: ${g}.png`}),document.getElementById("stamp-form").addEventListener("submit",function(o){if(o.preventDefault(),!s){alert("先に画像を選択してください。");return}const t=e.toDataURL("image/png"),i=atob(t.split(",")[1]),d=[];for(let n=0;n<i.length;n++)d.push(i.charCodeAt(n));const m=new Blob([new Uint8Array(d)],{type:"image/png"}),l=new FormData(this);l.append("image",m,`${g}.png`),fetch(this.action,{method:"POST",body:l,headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")}}).then(n=>{if(!n.ok)throw new Error("Network response was not ok "+n.statusText);return n.json()}).then(n=>{n.success?window.location.href="/tweets/index":alert("スタンプの作成に失敗しました。 "+n.message)}).catch(n=>{console.error("エラーが発生しました:",n),alert("スタンプの作成に失敗しました。 "+n.message)})})});
